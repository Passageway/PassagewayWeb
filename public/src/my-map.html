<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="google-map.html">

<dom-module id="my-map">
    <template>
    <style include="shared-styles">
        :host {
          display: block;

          padding: 10px;
        }

        google-map {
          height: 600px;
        }

        paper-toggle-button {
          padding-left: 8px;
          padding-right: 8px;
          padding-top: 10px;
          padding-bottom: 8px;
        }

        paper-material .toggle {
          position: absolute;
          right: 10px;
          padding: 0px;
          top: 10px;
          width: auto;
          height: auto;
        } </style>
      <google-map
        zoom="20"
        id="google-map"
        on-google-map-ready="_garbage"
        latitude="42.966637" longitude="-85.887161"
        api-key="AIzaSyAVUqR5YdD6osagKIQO2kYrw9mAjS9xaA0">
      </google-map>
    </template>
    <script>
        Polymer({
            is: 'my-map',

            properties: {
                heatData: {
                    type: Array,
                    notify: true,
                    observer: '_heatDataChanged'
                },
                units: {
                    type: Array,
                    notify: true,
                    observer: '_unitsChanged'
                }
            },

            _unitsChanged: function(newData, oldData) {
                this._retrieveUnitsForBuilding("Mackinac");
            },

            _retrieveUnitsForBuilding: function() {
                this.units.forEach(function(unit) {
                    unit.weight = 0;
                });
                this._retrieveTraffic(this.units);
            },

            _retrieveTraffic: function(units) {
                var trafficRef = firebase.database().ref('data');
                var heatArray = [];

                trafficRef.on('value', function(deviceMap) {
                  var devices = toArray(deviceMap);
                  devices.forEach(function(device) {
                    units.forEach(function(unit) {
                      if (key(unit) === key(device)) {
                          console.log("unit:" + key(unit));
                          console.log("device:" + key(device));
                        // var events = toArray(device);
                        //     unit.weight += .entry + .exit;
//                        heatArray.push(newHeatPoint(unit.value.latitude, unit.value.longitude, unit.weight));
                      }
                    });
                  });
                })(heatArray);
                this.heatData = heatArray;
            },


            _heatDataChanged: function(newVal, oldVal) {
                if (this.heatData) {
                    console.log(this.heatData);
                    var sensorData = [];
                    for (var k = 0; k < this.heatData.length; k++) {
                        sensorData.push(new google.maps.LatLng(
                            this.heatData[k].lat, this.heatData[k].lon));
                    }
                    var hmap = new google.maps.visualization.HeatmapLayer();
                    hmap.setData(sensorData);
                    // hmap.setMap(elem.map);
                }
            },

            _garbage: function() {
              var heatMapData = [
                {location: new google.maps.LatLng(37.782, -122.447), weight: 0.5},
                new google.maps.LatLng(37.782, -122.445),
                {location: new google.maps.LatLng(37.782, -122.443), weight: 2},
                {location: new google.maps.LatLng(37.782, -122.441), weight: 3},
                {location: new google.maps.LatLng(37.782, -122.439), weight: 2},
                new google.maps.LatLng(37.782, -122.437),
                {location: new google.maps.LatLng(37.782, -122.435), weight: 0.5},

                {location: new google.maps.LatLng(37.785, -122.447), weight: 3},
                {location: new google.maps.LatLng(37.785, -122.445), weight: 2},
                new google.maps.LatLng(37.785, -122.443),
                {location: new google.maps.LatLng(37.785, -122.441), weight: 0.5},
                new google.maps.LatLng(37.785, -122.439),
                {location: new google.maps.LatLng(37.785, -122.437), weight: 2},
                {location: new google.maps.LatLng(37.785, -122.435), weight: 3}
              ];

              var sanFrancisco = new google.maps.LatLng(37.774546, -122.433523);

              map = new google.maps.Map(document.getElementById('google-map'), {
                center: sanFrancisco,
                zoom: 13,
                mapTypeId: 'satellite'
              });

              var heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatMapData
              });
              heatmap.setMap(map);
            }
        });

        function toArray(obj) {
            return Object.keys(obj).map(function(key) {
                return {
                    name: key,
                    value: obj[key]
                };
            });
        }

        function key(object) {
          return Object.keys(object)[0];
        }

        function newHeatPoint(pLat, pLon, pWeight) {
            return {
                lat: pLat,
                lon: pLon,
                weight: pWeight
            };
        }
    </script>
</dom-module>
